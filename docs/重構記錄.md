# EduDepression 專案重構記錄

## 重構時間

2025-05-18

## 重構目標

將單一檔案 `run_analysis.py` 重構為模組化架構，並擴充 SQL 與 Grafana 視覺化功能。

## 重構記錄

### 1. 檔案架構掃描

- 已有：`data/student_depression_dataset.csv`、`run_analysis.py`、`src/__init__.py`
- 待新增：`src/preprocess.py`、`src/plot_utils.py`、`src/db_utils.py`、`src/model_utils.py`、`db/create_table.sql`

### 2. 模組拆分計劃

- `preprocess.py`：資料前處理與特徵工程
- `plot_utils.py`：視覺化函式
- `db_utils.py`：MySQL 相關功能
- `model_utils.py`：模型訓練與評估
- `run_analysis.py`：主控程式（保留主流程邏輯）

### 3. 執行過程與問題紀錄

#### 3.1 模組建立與功能拆分

- ✅ 建立 `src/preprocess.py`：將資料讀取、前處理、特徵工程等功能拆分為獨立函數
- ✅ 建立 `src/plot_utils.py`：將視覺化功能拆分為獨立圖表繪製函數
- ✅ 建立 `src/db_utils.py`：新增 MySQL 資料庫連接、匯入匯出功能
- ✅ 建立 `src/model_utils.py`：將模型訓練與評估功能拆分為獨立函數
- ✅ 建立 `db/create_table.sql`：設計 MySQL 資料表結構與建表語法

#### 3.2 資料驗證與一致性確認

- ✅ 確認學業壓力分類標準（低壓力/中壓力/高壓力）與報告一致
- ✅ 確認各壓力層級的憂鬱比例計算結果：低壓力組 19.44%、中壓力組 52.03%、高壓力組 81.63%
- ✅ 確認卡方檢定結果：χ² ≈ 5740.656, df=2, p<0.001
- ✅ 確認模型效能指標：Logistic 回歸準確率 ≈ 73.4%、AUC ≈ 0.805；Random Forest 準確率 ≈ 69.0%、AUC ≈ 0.751
- ✅ 確認學業壓力與憂鬱風險的相關係數 r ≈ 0.475

#### 3.3 MySQL 與 Grafana 整合

- ✅ 設計完整建表語法，包含所有必要欄位與索引
- ✅ 新增 MySQL 表視圖（View）設計，方便 Grafana 查詢
- ✅ 實作資料匯出功能，支援 DataFrame 轉 MySQL
- ✅ 提供 Grafana 連接與視覺化範例查詢

#### 3.4 重構主程式 run_analysis.py

- ✅ 重寫主程式流程，調用各模組功能
- ✅ 新增命令列參數支援（`--to-mysql`）
- ✅ 確保輸出結果與報告一致性
- ✅ 保留資料流程：讀取 → 處理 → 分析 → 視覺化 → （可選）MySQL 匯出

### 4. 執行結果驗證

#### 4.1 數值一致性

| 指標                       | 報告數值 | 程式輸出 | 驗證結果 |
| -------------------------- | -------- | -------- | -------- |
| 學業壓力與憂鬱風險相關係數 | 0.475    | 0.475    | ✅ 一致  |
| 卡方值（χ²）               | 5740.656 | 5740.656 | ✅ 一致  |
| 低壓力組憂鬱比例           | 19.44%   | 19.44%   | ✅ 一致  |
| 中壓力組憂鬱比例           | 52.03%   | 52.03%   | ✅ 一致  |
| 高壓力組憂鬱比例           | 81.63%   | 81.63%   | ✅ 一致  |
| Logistic Regression 準確率 | 73.4%    | 73.4%    | ✅ 一致  |
| Logistic Regression AUC    | 0.805    | 0.805    | ✅ 一致  |
| Random Forest 準確率       | 69.0%    | 69.0%    | ✅ 一致  |
| Random Forest AUC          | 0.751    | 0.751    | ✅ 一致  |

#### 4.2 功能完整性

- ✅ 資料讀取與前處理功能正常
- ✅ 特徵工程與分類功能正常
- ✅ 統計檢定與模型訓練功能正常
- ✅ 視覺化圖表生成功能正常
- ✅ MySQL 匯入匯出功能正常

### 5. 擴展方向與建議

#### 5.1 報告建議

- 建議添加 PCA 分析視覺化圖表，以強化報告中的數據說明
- 建議增加模型交叉驗證，提供更穩健的模型評估結果

#### 5.2 系統擴展方向

- 實作 Grafana 面板設計，建立直覺化的視覺化儀表板
- 增加資料自動更新機制，支援定期重新訓練模型
- 建立簡單的 Web 界面，讓非技術使用者也能執行分析
- 增加預測 API，讓其他系統可以呼叫模型進行預測

#### 5.3 技術優化方向

- 考慮引入 Docker 容器化，提供更一致的執行環境
- 增加單元測試與整合測試，提高程式碼可靠性
- 實作日誌系統，方便追蹤執行過程與除錯
- 考慮使用 Apache Airflow 等工具建立完整的資料分析流程

## 結論

本次重構順利完成，成功將單一 `run_analysis.py` 拆分為模組化架構，並新增 MySQL 與 Grafana 整合功能。新的架構更易於維護與擴展，同時保持與原始報告的數值一致性與結論一致性。
